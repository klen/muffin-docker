name: build

on:
  workflow_run:
    workflows: [tests]
    branches: [master]
    types: [completed]

jobs:

  build:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    strategy:
      fail-fast: true
      matrix:
        version: [py37, py38, py39, latest]

    steps:

    - name: Checkout changes
      uses: actions/checkout@v2.3.4

    - name: Login to docker hub
      run: make login PASSWORD=${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Build and upload basic image
      run: make upload TAG=${{ matrix.version }}

    - name: Build and upload node image
      run: make upload TAG=${{ matrix.version }}-node

